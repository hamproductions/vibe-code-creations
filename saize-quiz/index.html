<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>サイゼリヤメニュー番号学習アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background-color: #f7f7f7;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 1rem;
      }
      .container {
        max-width: 600px;
        width: 100%;
        background-color: #ffffff;
        border-radius: 1.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        padding: 2.5rem;
        text-align: center;
      }
      .message-box {
        background-color: #e2e8f0;
        padding: 1rem;
        border-radius: 0.75rem;
        margin-top: 1.5rem;
        font-size: 1rem;
        color: #4b5563;
        text-align: left;
      }
      .option-button {
        background-color: #e2e8f0;
        color: #1a202c;
        width: 100%;
        padding: 1rem;
        border-radius: 0.75rem;
        font-weight: 600;
        margin-top: 1rem;
        transition: background-color 0.3s, transform 0.1s;
        text-align: left;
      }
      .option-button:hover {
        background-color: #cbd5e1;
      }
      .option-button:active {
        transform: scale(0.98);
      }
      .correct-answer {
        background-color: #48bb78;
        color: white;
      }
      /* New class for wrong answers */
      .wrong-answer {
        background-color: #ef4444;
        color: white;
      }
      /* Bubbly button styles */
      .bubbly-button {
        background-image: linear-gradient(to right, #4f46e5 0%, #6366f1 100%);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .bubbly-button:hover {
        background-image: linear-gradient(to right, #4338ca 0%, #4f46e5 100%);
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
      }
      .bubbly-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .start-button,
      .next-button {
        width: 100%;
      }
      .search-mode-button {
        background-image: linear-gradient(to right, #10b981 0%, #34d399 100%);
      }
      .search-mode-button:hover {
        background-image: linear-gradient(to right, #059669 0%, #10b981 100%);
      }
      .category-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
        margin-bottom: 1rem;
      }
      .category-button {
        background-color: #e2e8f0;
        color: #1a202c;
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        transition: background-color 0.3s;
      }
      .category-button.active {
        background-color: #4f46e5;
        color: white;
      }
      .clear-all-button {
        background-image: linear-gradient(to right, #6b7280 0%, #9ca3af 100%);
      }
      .clear-all-button:hover {
        background-image: linear-gradient(to right, #4b5563 0%, #6b7280 100%);
      }
      .button-group {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
      }
      /* Search Section Styles */
      .search-input {
        width: 100%;
        padding: 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.75rem;
        font-size: 1rem;
        outline: none;
        transition: border-color 0.3s;
      }
      .search-input:focus {
        border-color: #4f46e5;
      }
      .search-result-item {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        padding: 1rem;
        text-align: left;
        margin-bottom: 0.75rem;
      }
      .search-result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.25rem;
      }
      .result-number {
        font-weight: 700;
        color: #4f46e5;
        font-size: 1.1rem;
      }
      .result-price {
        font-size: 0.875rem;
        color: #64748b;
      }
      .result-name {
        font-weight: 600;
        color: #1e293b;
      }
      .result-category {
        font-size: 0.75rem;
        color: #94a3b8;
        margin-top: 0.25rem;
      }
      #loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 50;
      }
      #loading-overlay.hidden {
        display: none;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4f46e5;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="loading-overlay">
      <div class="spinner"></div>
    </div>

    <div class="container">
      <h1 class="text-3xl font-bold text-gray-800">
        サイゼリヤメニュー番号学習アプリ
      </h1>
      <p class="mt-2 text-gray-600">法則を意識して番号を覚えよう！</p>

      <!-- Main Menu Section -->
      <div id="category-section">
        <h2 class="text-xl font-bold mt-6 mb-2 text-gray-800">
          クイズに挑戦するカテゴリーを選んでください
        </h2>
        <div class="category-selector" id="category-selector"></div>
        <div class="button-group flex-col">
          <div class="flex gap-2 w-full">
            <button
                id="clear-all-button"
                class="bubbly-button clear-all-button w-1/2"
            >
                全クリア
            </button>
            <button
                id="start-button"
                class="bubbly-button start-button w-1/2 mt-0"
            >
                クイズを開始
            </button>
          </div>
          <button id="search-mode-button" class="bubbly-button search-mode-button w-full mt-2">
            メニュー検索
          </button>
        </div>
      </div>

      <!-- Quiz Section -->
      <div id="quiz-section" class="hidden">
        <div id="quiz-display" class="mt-8">
          <p
            id="category-hint"
            class="text-sm font-semibold text-gray-500 hidden"
          ></p>
          <p class="text-xl text-gray-800 font-semibold mt-2">メニュー名:</p>
          <p id="menu-name" class="text-2xl mt-2 font-bold text-indigo-700"></p>
        </div>
        <button
          id="hint-button"
          class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-xl mt-4"
        >
          ヒントを表示
        </button>
        <div id="options-container" class="mt-4"></div>
        <!-- Updated spacing for the next button -->
        <button id="next-button" class="bubbly-button next-button hidden mt-6">
          次の問題へ
        </button>
        <button id="quiz-back-button" class="text-gray-500 mt-6 underline text-sm hover:text-gray-700">
            タイトルに戻る
        </button>
      </div>

      <!-- Search Section -->
      <div id="search-section" class="hidden text-left">
        <h2 class="text-xl font-bold mt-6 mb-4 text-gray-800 text-center">
            メニュー検索
        </h2>
        <div class="mb-4">
            <input
                type="text"
                id="search-input"
                class="search-input"
                placeholder="番号 (例: 1401) または メニュー名"
            >
        </div>
        <div id="search-results" class="space-y-2 max-h-[400px] overflow-y-auto pr-2">
            <!-- Results will be injected here -->
            <p class="text-center text-gray-400 py-4">検索してください</p>
        </div>
        <div class="text-center mt-6">
            <button id="search-back-button" class="bubbly-button clear-all-button w-full">
                タイトルに戻る
            </button>
        </div>
      </div>

      <div id="message-box" class="message-box hidden">
        <p id="message-text"></p>
      </div>
    </div>

    <script>
      let menuData = [];

      const categoryMap = {
        1: "前菜・サラダ・スープ",
        2: "メインディッシュ (ドリア・ピザ・パスタ・肉)",
        3: "ライス・パン・デザート・アルコール",
        4: "トッピング",
        5: "ドリンク・調味料"
      };

      let currentMenu = null;
      let shuffledMenus = [];
      let selectedCategories = [];

      // Elements
      const loadingOverlay = document.getElementById("loading-overlay");
      const categorySection = document.getElementById("category-section");
      const quizSection = document.getElementById("quiz-section");
      const searchSection = document.getElementById("search-section");

      const startButton = document.getElementById("start-button");
      const clearAllButton = document.getElementById("clear-all-button");
      const searchModeButton = document.getElementById("search-mode-button");
      const categorySelector = document.getElementById("category-selector");
      const hintButton = document.getElementById("hint-button");
      const categoryHintElement = document.getElementById("category-hint");
      const menuNameElement = document.getElementById("menu-name");
      const optionsContainer = document.getElementById("options-container");
      const nextButton = document.getElementById("next-button");
      const quizBackButton = document.getElementById("quiz-back-button");
      const searchBackButton = document.getElementById("search-back-button");

      const messageBox = document.getElementById("message-box");
      const messageText = document.getElementById("message-text");

      const searchInput = document.getElementById("search-input");
      const searchResults = document.getElementById("search-results");

      // --- Initialization ---
      async function fetchMenuData() {
        try {
            const response = await fetch('https://raw.githubusercontent.com/ryohidaka/saizeriya-menus/refs/heads/main/saizeriya.json');
            if (!response.ok) throw new Error("Failed to load data");
            const data = await response.json();

            // Transform data to match app needs
            menuData = data.menus.map(item => ({
                name: item.name,
                number: item.id.toString(),
                category: mapGenreToCategory(item), // Function to group for the quiz
                original: item // Keep original data for details
            }));

            // Filter out items that don't have a valid 4-digit ID starting with 1-5
            menuData = menuData.filter(item => {
                const num = parseInt(item.number);
                return !isNaN(num) && item.number.length === 4;
            });

            createCategoryButtons();
            loadingOverlay.classList.add('hidden');
        } catch (error) {
            console.error(error);
            loadingOverlay.innerHTML = `<p class="text-red-500 font-bold">データの読み込みに失敗しました。<br>再読み込みしてください。</p>`;
        }
      }

      function mapGenreToCategory(item) {
         // Map based on the first digit of the ID for quiz grouping
         const firstDigit = item.id.toString().charAt(0);
         if (categoryMap[firstDigit]) {
             // We can use the detailed genre from the JSON for better grouping if desired,
             // but for now let's stick to the broad categories derived from ID
             // to match the original app logic.
             // Or we can use item.genre directly?
             // The original app used custom strings like "前菜・サラダ・スープ".
             // Let's rely on the first digit to assign the "Quiz Category Group".
             return categoryMap[firstDigit];
         }
         return "その他";
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      }

      function createCategoryButtons() {
        const uniqueCategories = [
          ...new Set(menuData.map((item) => item.category))
        ];

        // Group by first digit
        const categoryGroups = {};
        uniqueCategories.forEach((cat) => {
            // Find an example item to get the digit
            const example = menuData.find((item) => item.category === cat);
            if(example) {
                const firstDigit = example.number.charAt(0);
                if (!categoryGroups[firstDigit]) {
                    categoryGroups[firstDigit] = [];
                }
                if (!categoryGroups[firstDigit].includes(cat)) {
                    categoryGroups[firstDigit].push(cat);
                }
            }
        });

        const sortedKeys = Object.keys(categoryGroups).sort();

        sortedKeys.forEach((key) => {
          const groupName = categoryMap[key] || `その他`;
          const header = document.createElement("h3");
          header.className = "text-lg font-bold w-full mt-4 mb-2 text-indigo-600 border-b border-indigo-100 pb-1";
          header.textContent = `${key}000番台`;
          categorySelector.appendChild(header);

          categoryGroups[key].forEach((cat) => {
            const button = document.createElement("button");
            button.className = "category-button active m-1";
            button.textContent = cat; // This will now likely just be the mapped name
            button.dataset.category = cat;
            button.addEventListener("click", () => {
              button.classList.toggle("active");
              updateSelectedCategories();
            });
            categorySelector.appendChild(button);
          });
        });
        updateSelectedCategories();
      }

      function updateSelectedCategories() {
        const activeButtons = categorySelector.querySelectorAll(
          ".category-button.active"
        );
        selectedCategories = Array.from(activeButtons).map(
          (btn) => btn.dataset.category
        );
      }

      function clearAllCategories() {
        const allButtons =
          categorySelector.querySelectorAll(".category-button");
        allButtons.forEach((btn) => {
          btn.classList.remove("active");
        });
        updateSelectedCategories();
      }

      // --- Quiz Logic ---
      function startQuiz() {
        if (selectedCategories.length === 0) {
          showMessage(
            "error",
            "クイズを開始するには、少なくとも1つのカテゴリーを選択してください。"
          );
          return;
        }
        shuffledMenus = menuData.filter((menu) =>
          selectedCategories.includes(menu.category)
        );
        shuffleArray(shuffledMenus);
        categorySection.classList.add("hidden");
        quizSection.classList.remove("hidden");
        document.addEventListener("keydown", handleKeyDown); // Enable keyboard input
        showMessage("none");
        displayNextQuestion();
      }

      function getWrongAnswers(correctNumber, correctCategory) {
        const allNumbersInThisCategory = menuData
          .filter((item) => item.category === correctCategory)
          .map((item) => item.number);
        const wrongNumbers = allNumbersInThisCategory.filter(
          (num) => num !== correctNumber
        );
        shuffleArray(wrongNumbers);
        return wrongNumbers.slice(0, 3);
      }

      function displayNextQuestion() {
        if (shuffledMenus.length === 0) {
          endQuiz();
          return;
        }
        currentMenu = shuffledMenus.pop();

        const firstDigit = currentMenu.number.charAt(0);
        // Hint is now hidden by default
        categoryHintElement.textContent = `ヒント: ${firstDigit}000番台は${
          categoryMap[firstDigit] || "その他"
        }のメニューです。`;
        categoryHintElement.classList.add("hidden");

        menuNameElement.textContent = currentMenu.name;
        optionsContainer.innerHTML = "";

        // Ensure we have enough wrong answers even if category is small
        let wrongNumbers = getWrongAnswers(
          currentMenu.number,
          currentMenu.category
        );

        // If not enough wrong answers in category, pick from global
        if(wrongNumbers.length < 3) {
             const otherNumbers = menuData
                .filter(item => item.number !== currentMenu.number && !wrongNumbers.includes(item.number))
                .map(item => item.number);
             shuffleArray(otherNumbers);
             wrongNumbers = [...wrongNumbers, ...otherNumbers.slice(0, 3 - wrongNumbers.length)];
        }

        const options = [...wrongNumbers, currentMenu.number];
        shuffleArray(options);

        options.forEach((option, index) => {
          const button = document.createElement("button");
          button.className = "option-button";
          button.textContent = `${index + 1}. ${option}`; // Add number for keyboard input hint
          button.dataset.number = option;
          button.addEventListener("click", () => checkAnswer(button));
          optionsContainer.appendChild(button);
        });

        nextButton.classList.add("hidden");
        hintButton.disabled = false;
        showMessage("none");
      }

      function checkAnswer(clickedButton) {
        const selectedNumber = clickedButton.dataset.number;
        const allButtons = optionsContainer.querySelectorAll(".option-button");

        const isCorrect = selectedNumber === currentMenu.number;
        const correctAnswerObject = menuData.find(
          (item) => item.number === currentMenu.number
        );

        // Add the 'wrong-answer' class to the user's selected button if it's incorrect
        if (!isCorrect) {
          clickedButton.classList.add("wrong-answer");
        }

        allButtons.forEach((btn) => {
          btn.disabled = true;
          const optionNumber = btn.dataset.number;
          const optionMenu = menuData.find(
            (item) => item.number === optionNumber
          );
          // Show full menu name and number after selection
          btn.textContent = `${optionNumber}：${
            optionMenu ? optionMenu.name : "（メニュー名不明）"
          }`;

          // Only highlight the correct answer
          if (optionNumber === currentMenu.number) {
            btn.classList.add("correct-answer");
          }
        });

        if (isCorrect) {
          showMessage("correct", "正解！");
        } else {
          showMessage(
            "wrong",
            `残念！正解は ${correctAnswerObject.number} の「${correctAnswerObject.name}」でした。`
          );
        }
        nextButton.classList.remove("hidden");
        hintButton.disabled = true;
      }

      function endQuiz() {
        menuNameElement.textContent = "クイズ終了！お疲れさまでした！";
        categoryHintElement.textContent = "";
        optionsContainer.innerHTML = "";
        nextButton.classList.add("hidden");
        startButton.textContent = "もう一度プレイする";
        returnToTitle();
      }

      function returnToTitle() {
          categorySection.classList.remove("hidden");
          quizSection.classList.add("hidden");
          searchSection.classList.add("hidden");
          document.removeEventListener("keydown", handleKeyDown); // Disable keyboard input
          showMessage("none");
      }

      // Updated function to handle keyboard input
      function handleKeyDown(event) {
        const key = event.key;
        // Check if an answer has been selected (i.e., the next button is visible)
        if (!nextButton.classList.contains("hidden")) {
          if (key === "Enter" || key === " ") {
            displayNextQuestion();
          }
        } else if (
          !quizSection.classList.contains("hidden") &&
          optionsContainer.children.length > 0 &&
          ["1", "2", "3", "4"].includes(key)
        ) {
          // Otherwise, check if a number key was pressed to select an answer
          const index = parseInt(key) - 1;
          const selectedButton = optionsContainer.children[index];
          if (selectedButton && !selectedButton.disabled) {
            checkAnswer(selectedButton);
          }
        }
      }

      function showMessage(type, text = "") {
        if (type === "none") {
          messageBox.classList.add("hidden");
        } else {
          messageBox.classList.remove("hidden");
          messageText.textContent = text;
          messageText.className = "";
          if (type === "correct") {
            messageText.classList.add("text-green-700");
          } else if (type === "wrong" || type === "error") {
            messageText.classList.add("text-red-700");
          }
        }
      }

      // --- Search Logic ---
      function openSearchMode() {
          categorySection.classList.add("hidden");
          searchSection.classList.remove("hidden");
          searchInput.value = "";
          updateSearchResults("");
          searchInput.focus();
      }

      function updateSearchResults(query) {
          const cleanQuery = query.trim().toLowerCase();

          if (cleanQuery === "") {
              searchResults.innerHTML = '<p class="text-center text-gray-400 py-4">番号またはメニュー名を入力</p>';
              return;
          }

          const filtered = menuData.filter(item => {
              return item.name.includes(cleanQuery) || item.number.includes(cleanQuery);
          });

          if (filtered.length === 0) {
              searchResults.innerHTML = '<p class="text-center text-gray-400 py-4">見つかりませんでした</p>';
              return;
          }

          searchResults.innerHTML = filtered.map(item => `
            <div class="search-result-item">
                <div class="search-result-header">
                    <span class="result-number">${item.number}</span>
                    <span class="result-price">¥${item.original.price_with_tax}</span>
                </div>
                <div class="result-name">${item.name}</div>
                <div class="result-category">${item.original.genre || item.category}</div>
            </div>
          `).join('');
      }

      // Event Listeners
      startButton.addEventListener("click", startQuiz);
      nextButton.addEventListener("click", displayNextQuestion);
      clearAllButton.addEventListener("click", clearAllCategories);
      hintButton.addEventListener("click", () => {
        categoryHintElement.classList.remove("hidden");
      });
      quizBackButton.addEventListener("click", returnToTitle);

      searchModeButton.addEventListener("click", openSearchMode);
      searchBackButton.addEventListener("click", returnToTitle);
      searchInput.addEventListener("input", (e) => updateSearchResults(e.target.value));

      // Initial Load
      fetchMenuData();

    </script>
  </body>
</html>
